%% LaTeX2e file `popupcite.sty'
%% generated by the `filecontents' environment
%% from source `111' on 2021/09/10.
%%
\usepackage{pdfcomment}
\hypersetup{unicode}
% suppress annoying hyperref warnings
\let\HyPsd@RemoveSpaceWarning\@gobble

%Fixes a bug in soulpos package (used by pdfcomment). Without this fix, pdfmarkupcomments don't play well with \clearpage. Copypasted from StackExchange.
\AtEndDocument{\clearpage\immediate\write\@auxout{\string\ulp@afterend}}

%read bbl file and parse it to grab full citations
\providecommand{\grabfullcitations}[1]{%
\begingroup
    %we don't need to typeset the reference section
    \def\thebibliography{\begingroup\@gobble}%
    \def\endthebibliography{\endgroup}%
    %The bibliography environment contains a list of bibitems delimited by empty lines. Let's redefine \bibitem to store the bibliographic entry in \fullcitation@<key>
    \def\bibitem[##1]##2 ##3\par{%
        \expandafter\gdef\csname fullcitation@##2\endcsname{##3}%
    }%
    %Now we can read the bbl file, and LaTeX will put the bibliographic entries in \fullcitation@<key>
    \input{#1}%
    %Syntactic sugar to access \fullcitation@<key> by typing \fullcitation{<key>}
    \gdef\fullcitation##1{\csname fullcitation@##1\endcsname}%
\endgroup%
}

%We need to attach a popup to each citation label. \cite function takes citation keys and outputs all the labels altogether, so we have to interfere somewhere in its internals. Since hyperref already works with each label separately, let's patch its \hyper@natlinkstart function. The most cross-viewer kind of popups are PDF Underline annotations, which are provided by the pdfcomment package. So we wrap each label in a \pdfmarkupcomment before creating a hyperlink. \pdfmarkupcomment parameters are chosen so as to make the underlining and annotation author/date/etc. invisible.
\let\hyper@natlinkstart@old\hyper@natlinkstart
\def\hyper@natlinkstart#1#2{%
  \hyper@natlinkstart@old{#1}%
  \pdfmarkupcomment[markup=Underline,color={1 1 1},opacity=0,subject={},author={},date={{ }}]{{#2}}{\fullcitation{#1}}%
}%
